# Lab 31-10-2023

I undertook these steps to generate certificates:

## CA certificate.
After downloading XCA I created a new database in the application and started to create the CA certificate.
I filled this in at the subject:

![Alt text](Images/certificates/sub_ca_cert.png)

Then generated a new key:

![Alt text](Images/certificates/succes_create_key.png)

next in extensions I changed the type to Certification Authority:

![Alt text](Images/certificates/Ext_crea_cert.png)

In the tab Key usage I clicked on Certificate sign and CRL sign to use these in the certificate:

![Alt text](Images/certificates/key_usage.png)

And Advanced I checked if it would work:

![Alt text](Images/certificates/CA_Advanced.png)

Next I clicked on OK and this window popped up:

![Alt text](Images/certificates/cert_creat_succes.png)

Next I checked the Private keys and there is a root CA key now.

![Alt text](Images/certificates/private_key_root.png)

Next I exported the certificate, this gave an error at first, but I changed later the directory it needs to be saved in:

![Alt text](Images/certificates/Certificate%20Export.png)

## broker certificate
After the CA certificate had been made, the broker certificate kan be made. I used these subject settings and also generated a new key:

![Alt text](Images/certificates/broker_cert_subject.png)

The private key has ben created:

![Alt text](Images/certificates/private_gen_broker.png)

Next in extensions I edited the X509 Subject Alternative Name to this:

![Alt text](Images/certificates/edit_X509.png)

After applying it, I changed the type to End Entity in the extensions tab.

![Alt text](Images/certificates/broker_extensions.png)

I checked everything in the advanced tab:

![Alt text](Images/certificates/advanced_broker.png)

I clicked on OK and the certificate was generated succesfully:

![Alt text](Images/certificates/Key_broker_gen.png)

Now in the certificates tab there is an End Entity in the Root CA.

![Alt text](Images/certificates/certificates_tab_end_entity.png)

I exported the End Entity to the same directory:

![Alt text](Images/certificates/export_end_entity.png)

And also exported the public key of the End Entity:

![Alt text](Images/certificates/Export_Pub_key_End.png)

I checked if everything was there in my file folder:

![Alt text](Images/certificates/documetns.png)


## Install cert on Firefox

Install the root CA certificate on your webbrowser.
- Open Firefox and go to Options:
- Click Privacy & Security in the left-hand menu and scroll down to Certificates.
- Click View Certificates... and the Certificate Manager window displays.
- Click Authorities and then Import....
- Browse to locate the downloaded ca. ...
- Click OK.

![Alt text](Images/certificates/Cert_manager_firefox.png)

## Running the certificate on the router
Using winscp transferred certificate files to the router in a directory named Jesper.

![Alt text](Images/certificates/winscp.png)

Firstly I needed to turn of the mqttbroker: */etc/init.d/mqttbroker stop*.

Next used this command next in ssh:

```css
mqttbroker mqtttlswebview tls --cert-chain End_Entity_-_GA_it_in_IT_-_MQTT_Broker.crt --cert-key End_Entity_-_GA_it_in_IT_-_MQTT_Broker.pem
```
This happened:

![Alt text](Images/certificates/run_mqtt_cert_command.png)


Went to https://192.168.12.254:8088/clients/

![Alt text](Images/certificates/web_page.png)

Went to more information and this is the certificate:

![Alt text](Images/certificates/Certificate_works.png)

And this is PuTTY output:

![Alt text](Images/certificates/PuTTY_output_cert.png)

## Node-Red


mqttbroker mqtttlswebview tls --cert-chain End_Entity_-_Ga_in_IT_-_MQTT_Broker.crt --cert-key End_Entity_-_Ga_in_IT_-_MQTT_Broker.pem


![Alt text](image.png)



![Alt text](image-4.png)



![Alt text](image-2.png)



![Alt text](image-1.png)

sender

![Alt text](image-7.png)

receiver

![Alt text](image-6.png)



![Alt text](image-3.png)



![Alt text](image-5.png)



Certificate and key for Node-Red

First mad a new certificate for Node-Red in XCA:

![Alt text](image-10.png)

Then uploaded it to Node red in the mqtt publisher: *Server>TLS configuration*

![Alt text](image-8.png)

Node-Red flow still connected

![Alt text](image-9.png)

